<mxfile host="app.diagrams.net" modified="2025-11-16T00:00:00.000Z" agent="5.0" version="22.1.11" etag="drawio-idempotency-financial" type="device">
  <diagram name="Idempotency in Financial System" id="idempotency-diagram">
    <mxGraphModel dx="1422" dy="1800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1800" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Título Principal -->
        <mxCell id="title" value="&lt;b&gt;&lt;font style=&quot;font-size: 24px;&quot;&gt;Idempotência em Sistema Financeiro&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="100" y="30" width="650" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="subtitle" value="Prevenção de Débito Duplicado com Identificador Único de Transação" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="125" y="70" width="600" height="25" as="geometry" />
        </mxCell>
        
        <!-- Linha Divisória -->
        <mxCell id="divider1" value="" style="endArrow=none;html=1;strokeColor=#000000;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="70" y="120" as="sourcePoint" />
            <mxPoint x="780" y="120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- =============== PRODUCER =============== -->
        <mxCell id="producer-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="70" y="150" width="710" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="producer-title" value="&lt;b&gt;SISTEMA DE ORIGEM&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="300" y="160" width="250" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="producer-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="230" y="200" width="390" height="70" as="geometry" />
        </mxCell>
        
        <mxCell id="producer-label" value="&lt;b&gt;PAYMENT GATEWAY&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;Recebe solicitação de débito e publica no Kafka&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="255" y="215" width="340" height="40" as="geometry" />
        </mxCell>
        
        <!-- =============== KAFKA TOPIC =============== -->
        <mxCell id="kafka-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="70" y="330" width="710" height="240" as="geometry" />
        </mxCell>
        
        <mxCell id="kafka-title" value="&lt;b&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;KAFKA TOPIC: &quot;debit-transactions&quot;&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontColor=#ffffff;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="225" y="345" width="400" height="30" as="geometry" />
        </mxCell>
        
        <!-- Seta Producer -> Kafka -->
        <mxCell id="arrow-prod-kafka" value="&lt;b&gt;publish()&lt;/b&gt;" style="endArrow=classic;html=1;strokeColor=#000000;strokeWidth=3;fontSize=11;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="producer-section" target="kafka-section">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Mensagens com Transaction ID -->
        <mxCell id="msg1-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="120" y="400" width="300" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="msg1-title" value="&lt;b&gt;MENSAGEM 1&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="145" y="410" width="250" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="msg1-content" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 9px;&quot;&gt;{&lt;br&gt;  &quot;transaction_id&quot;: &quot;txn-001-abc-xyz&quot;,&lt;br&gt;  &quot;account_id&quot;: &quot;ACC-12345&quot;,&lt;br&gt;  &quot;amount&quot;: 150.00,&lt;br&gt;  &quot;currency&quot;: &quot;BRL&quot;,&lt;br&gt;  &quot;timestamp&quot;: &quot;2024-11-16T10:30:00Z&quot;,&lt;br&gt;  &quot;description&quot;: &quot;Pagamento Boleto&quot;&lt;br&gt;}&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="135" y="440" width="270" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="msg2-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="400" width="300" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="msg2-title" value="&lt;b&gt;MENSAGEM 2 (RETRY/DUPLICADA)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="475" y="410" width="250" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="msg2-content" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 9px;&quot;&gt;{&lt;br&gt;  &quot;transaction_id&quot;: &quot;txn-001-abc-xyz&quot;,&lt;br&gt;  &quot;account_id&quot;: &quot;ACC-12345&quot;,&lt;br&gt;  &quot;amount&quot;: 150.00,&lt;br&gt;  &quot;currency&quot;: &quot;BRL&quot;,&lt;br&gt;  &quot;timestamp&quot;: &quot;2024-11-16T10:30:05Z&quot;,&lt;br&gt;  &quot;description&quot;: &quot;Pagamento Boleto&quot;&lt;br&gt;}&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="465" y="440" width="270" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="msg-note" value="⚠️ MESMO transaction_id" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=1;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="450" y="380" width="300" height="20" as="geometry" />
        </mxCell>
        
        <!-- Seta Kafka -> Consumer -->
        <mxCell id="arrow-kafka-cons" value="&lt;b&gt;poll()&lt;/b&gt;" style="endArrow=classic;html=1;strokeColor=#000000;strokeWidth=3;fontSize=11;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="kafka-section" target="consumer-section">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- =============== CONSUMER COM IDEMPOTÊNCIA =============== -->
        <mxCell id="consumer-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="70" y="620" width="710" height="550" as="geometry" />
        </mxCell>
        
        <mxCell id="consumer-title" value="&lt;b&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;CONSUMER: DEBIT SERVICE (COM VERIFICAÇÃO DE IDEMPOTÊNCIA)&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="145" y="635" width="560" height="30" as="geometry" />
        </mxCell>
        
        <!-- Fluxo Mensagem 1 -->
        <mxCell id="flow1-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="120" y="690" width="300" height="450" as="geometry" />
        </mxCell>
        
        <mxCell id="flow1-title" value="&lt;b&gt;PROCESSAMENTO: MENSAGEM 1&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="145" y="700" width="250" height="25" as="geometry" />
        </mxCell>
        
        <!-- Step 1 -->
        <mxCell id="step1-1" value="&lt;b&gt;1. Recebe Mensagem&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="140" y="740" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-1-detail" value="transaction_id: txn-001-abc-xyz" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="140" y="772" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 2 -->
        <mxCell id="step1-2" value="&lt;b&gt;2. Verifica no Cache/DB&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="140" y="800" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-2-query" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 7px;&quot;&gt;SELECT * FROM processed_transactions&lt;br&gt;WHERE transaction_id = 'txn-001-abc-xyz'&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=7;" vertex="1" parent="1">
          <mxGeometry x="145" y="833" width="250" height="20" as="geometry" />
        </mxCell>
        
        <!-- Step 3 -->
        <mxCell id="step1-3" value="&lt;b&gt;3. Resultado: NÃO EXISTE&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="140" y="865" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-3-icon" value="✓ Primeira vez processando" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="140" y="897" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 4 -->
        <mxCell id="step1-4" value="&lt;b&gt;4. Executa Débito&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;strokeWidth=2;fontSize=10;align=center;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="140" y="925" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-4-detail" value="Debita R$ 150,00 da conta ACC-12345" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="140" y="957" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 5 -->
        <mxCell id="step1-5" value="&lt;b&gt;5. Registra Transaction ID&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="140" y="985" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-5-insert" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 7px;&quot;&gt;INSERT INTO processed_transactions&lt;br&gt;(transaction_id, processed_at, status)&lt;br&gt;VALUES ('txn-001-abc-xyz', NOW(), 'SUCCESS')&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=7;" vertex="1" parent="1">
          <mxGeometry x="145" y="1018" width="250" height="30" as="geometry" />
        </mxCell>
        
        <!-- Step 6 -->
        <mxCell id="step1-6" value="&lt;b&gt;6. Commit Offset&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="140" y="1060" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step1-result" value="✓ &lt;b&gt;DÉBITO REALIZADO&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;strokeWidth=2;fontSize=11;align=center;fontColor=#ffffff;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="155" y="1105" width="230" height="25" as="geometry" />
        </mxCell>
        
        <!-- Fluxo Mensagem 2 (Duplicada) -->
        <mxCell id="flow2-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="690" width="300" height="450" as="geometry" />
        </mxCell>
        
        <mxCell id="flow2-title" value="&lt;b&gt;PROCESSAMENTO: MENSAGEM 2 (RETRY)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="475" y="700" width="250" height="25" as="geometry" />
        </mxCell>
        
        <!-- Step 1 -->
        <mxCell id="step2-1" value="&lt;b&gt;1. Recebe Mensagem&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="470" y="740" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-1-detail" value="transaction_id: txn-001-abc-xyz (MESMO ID)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="470" y="772" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 2 -->
        <mxCell id="step2-2" value="&lt;b&gt;2. Verifica no Cache/DB&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="470" y="800" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-2-query" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 7px;&quot;&gt;SELECT * FROM processed_transactions&lt;br&gt;WHERE transaction_id = 'txn-001-abc-xyz'&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=7;" vertex="1" parent="1">
          <mxGeometry x="475" y="833" width="250" height="20" as="geometry" />
        </mxCell>
        
        <!-- Step 3 -->
        <mxCell id="step2-3" value="&lt;b&gt;3. Resultado: JÁ EXISTE ✓&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;strokeWidth=2;fontSize=10;align=center;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="470" y="865" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-3-icon" value="⚠️ Transação já processada anteriormente" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="470" y="897" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 4 -->
        <mxCell id="step2-4" value="&lt;b&gt;4. PULA Execução de Débito&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=2;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="470" y="925" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-4-detail" value="❌ NÃO debita novamente (idempotência)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="470" y="957" width="260" height="15" as="geometry" />
        </mxCell>
        
        <!-- Step 5 -->
        <mxCell id="step2-5" value="&lt;b&gt;5. Log de Duplicata&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="470" y="985" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-5-log" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 7px;&quot;&gt;log.warn(&quot;Duplicate transaction detected&quot;,&lt;br&gt;  transaction_id: 'txn-001-abc-xyz',&lt;br&gt;  action: 'IGNORED')&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=7;" vertex="1" parent="1">
          <mxGeometry x="475" y="1018" width="250" height="30" as="geometry" />
        </mxCell>
        
        <!-- Step 6 -->
        <mxCell id="step2-6" value="&lt;b&gt;6. Commit Offset&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="470" y="1060" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step2-result" value="✓ &lt;b&gt;DUPLICATA IGNORADA&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;fontSize=11;align=center;fontColor=#000000;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="485" y="1105" width="230" height="25" as="geometry" />
        </mxCell>
        
        <!-- =============== IDEMPOTENCY STORE =============== -->
        <mxCell id="store-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#000000;strokeColor=#000000;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="70" y="1220" width="710" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="store-title" value="&lt;b&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;IDEMPOTENCY STORE&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontColor=#ffffff;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="275" y="1235" width="300" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="store-subtitle" value="Tabela: processed_transactions (Redis Cache ou Database)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#ffffff;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="225" y="1265" width="400" height="20" as="geometry" />
        </mxCell>
        
        <!-- Tabela -->
        <mxCell id="table-header" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="120" y="1300" width="610" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="table-header-content" value="&lt;b&gt;transaction_id&lt;/b&gt; | &lt;b&gt;account_id&lt;/b&gt; | &lt;b&gt;amount&lt;/b&gt; | &lt;b&gt;processed_at&lt;/b&gt; | &lt;b&gt;status&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="130" y="1307" width="590" height="16" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="120" y="1330" width="610" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row1-content" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 8px;&quot;&gt;txn-001-abc-xyz | ACC-12345 | 150.00 | 2024-11-16 10:30:01 | SUCCESS&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;" vertex="1" parent="1">
          <mxGeometry x="130" y="1335" width="590" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="120" y="1355" width="610" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row2-content" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 8px;&quot;&gt;txn-002-def-uvw | ACC-67890 | 75.50 | 2024-11-16 10:31:12 | SUCCESS&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;" vertex="1" parent="1">
          <mxGeometry x="130" y="1360" width="590" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#000000;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="120" y="1380" width="610" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="table-row3-content" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 8px;&quot;&gt;txn-003-ghi-rst | ACC-11111 | 200.00 | 2024-11-16 10:32:45 | SUCCESS&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;" vertex="1" parent="1">
          <mxGeometry x="130" y="1385" width="590" height="15" as="geometry" />
        </mxCell>
        
        <!-- =============== BENEFÍCIOS =============== -->
        <mxCell id="benefits-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="70" y="1460" width="710" height="180" as="geometry" />
        </mxCell>
        
        <mxCell id="benefits-title" value="&lt;b&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;BENEFÍCIOS DA IDEMPOTÊNCIA&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="225" y="1475" width="400" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="benefit1" value="✓ &lt;b&gt;SEGURANÇA FINANCEIRA:&lt;/b&gt; Previne débitos duplicados, protegendo usuários e empresa" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="100" y="1520" width="650" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="benefit2" value="✓ &lt;b&gt;RETRY SEGURO:&lt;/b&gt; Permite reprocessamento de mensagens sem efeitos colaterais" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="100" y="1550" width="650" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="benefit3" value="✓ &lt;b&gt;AT-LEAST-ONCE:&lt;/b&gt; Garante entrega sem duplicação lógica de operações" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="100" y="1580" width="650" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="benefit4" value="✓ &lt;b&gt;AUDITORIA:&lt;/b&gt; Histórico completo de tentativas de processamento para investigação" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="100" y="1610" width="650" height="20" as="geometry" />
        </mxCell>
        
        <!-- =============== IMPLEMENTAÇÃO =============== -->
        <mxCell id="impl-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="70" y="1680" width="710" height="160" as="geometry" />
        </mxCell>
        
        <mxCell id="impl-title" value="&lt;b&gt;IMPLEMENTAÇÃO - Exemplo de Código&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=13;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="250" y="1690" width="350" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="impl-code" value="&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 8px;&quot;&gt;void processDebitTransaction(Message msg) {&lt;br&gt;    String transactionId = msg.getTransactionId();&lt;br&gt;    &lt;br&gt;    // Verifica se já foi processado&lt;br&gt;    if (idempotencyStore.exists(transactionId)) {&lt;br&gt;        log.warn(&quot;Duplicate transaction detected: {}&quot;, transactionId);&lt;br&gt;        consumer.commit(); // Commit sem reprocessar&lt;br&gt;        return; // Ignora duplicata&lt;br&gt;    }&lt;br&gt;    &lt;br&gt;    // Processa débito&lt;br&gt;    try {&lt;br&gt;        accountService.debit(msg.getAccountId(), msg.getAmount());&lt;br&gt;        &lt;br&gt;        // Registra transaction_id para idempotência&lt;br&gt;        idempotencyStore.save(transactionId, msg);&lt;br&gt;        &lt;br&gt;        consumer.commit();&lt;br&gt;        log.info(&quot;Transaction processed successfully: {}&quot;, transactionId);&lt;br&gt;    } catch (Exception e) {&lt;br&gt;        log.error(&quot;Transaction failed: {}&quot;, transactionId, e);&lt;br&gt;        // Não commit = retry na próxima leitura&lt;br&gt;    }&lt;br&gt;}&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=8;" vertex="1" parent="1">
          <mxGeometry x="100" y="1725" width="650" height="105" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>